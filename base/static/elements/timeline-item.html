<link rel="import" href="../bower/polymer/polymer.html">

<polymer-element name="timeline-item" attributes="date highlighted timeSpanStart timeSpanEnd">
    <template>
        <style>
            :host, .bubble {
                position: absolute;
                width: 0px;
                height: 0;
                margin: 0 0;
                padding: 0;
            }

            .bubble {
                display: inline-block;
                vertical-align: top;
                overflow: visible;
            }

            .entry-info {
                overflow: visible;
                background: #1C7ABF;
                color: #fff;
                font-size: 12px;
                text-align: center;
                border-radius: 8px;
                font-style: italic;
                width: 64px;
                height: 16px;
                display: none;
                position: relative;
                left: -32px;
            }

            .bubble.highlighted > .entry-info {
                display: block;
            }

            .bubble:after {
                content: '';
                display: block;
                background: #eee;
                width: 9px;
                height: 9px;
                border-radius: 7px;
                border: 2px solid #06182E;
                position: absolute;
                left: 50%;
                top: -25px;
                margin-left: -7px;
            }

            .entry-info:before {
                content: '';
                display: block;
                background: #06182E;
                width: 3px;
                height: 20px;
                position: absolute;
                left: 50%;
                top: -20px;
                margin-left: -2px;
            }

            .bubble.highlighted:after {
                background: #f3b300;
            }

            :host[now] .bubble:after {
                background: #009688;
            }
        </style>
        <div id="bubble" class="bubble" on-click="{{ clicked }}">
            <div class="entry-info">
                {{ dateString }}
            </div>
        </div>
        <div id="itemData" style="display: none">
            <content id="content"></content>
        </div>
    </template>
    <script>
        Polymer('timeline-item', {
            highlighted: false,
            date: 0,
            dateString: '?',
            timeSpanStart: 0,
            timeSpanEnd: 0,
            lineWidth: 0,
            timeSpanStartChanged: function () {
                this.update();
            },
            timeSpanEndChanged: function () {
                this.update();
            },
            dateChanged: function() {
                this.update();
                this.dateString = new Date(this.date * 1000);
            },
            lineWidthChanged: function() {
                this.update();
            },
            update:function(){
                var now = this.date;
                var perc = (now - this.timeSpanStart) / (this.timeSpanEnd - this.timeSpanStart);
                this.style.display = now >= this.timeSpanStart && now <= this.timeSpanEnd ? 'block' : 'none';
                //console.log(this.date, perc, Math.round(perc * this.lineWidth));
                this.style.left = Math.round(perc * this.lineWidth) + 'px';
            },
            ready:function(){
                this.update();
            },
            clicked: function () {
                if (this.highlighted) {
                    this.open();
                }
                else {
                    this.highlight();
                }
            },
            open: function() {
                this.fire('item-open');
            },
            highlight: function () {
                if (this.highlighted) {
                    return;
                }
                this.fire('item-highlighted');
                this.highlighted = true;
                this.$.bubble.classList.add('highlighted');
            },
            unhighlight: function () {
                if (!this.highlighted) {
                    return;
                }

                this.fire('item-unhighlighted');
                this.highlighted = false;
                this.$.bubble.classList.remove('highlighted');
            }
        });
    </script>

</polymer-element>