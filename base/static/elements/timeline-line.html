<link rel="import" href="../bower/polymer/polymer.html">
<link rel="import" href="../bower/core-collapse/core-collapse.html">
<link rel="import" href="../bower/paper-button/paper-button.html">

<link rel="import" href="timeline-item.html">
<link rel="import" href="timeline-now.html">

<polymer-element name="timeline-line" attributes="timeSpanStart timeSpanEnd" on-touchstart="{{ touchstart }}" on-touchmove="{{ touchmove }}"
                 on-touchend="{{ touchend }}" on-trackstart="{{ trackstart }}" on-trackend="{{ trackend }}"
                 on-track="{{ track }}">
<template>
    <style>
        :host {
            padding: 0;
            margin: 25px auto;
            overflow-y: scroll;
            overflow-x: auto;
            position: relative;
            padding: 10px 0;
        }

        .bar {
            height: 4px;
            background: #eee;
            width: 100%;
            position: relative;
            top: 13px;
            left: 0;
        }

        .timeline {
            white-space: nowrap;
            padding: 30px 0 20px 0;
            position: relative;
        }

        #collapsebox {
            padding: 10px;
        }

        #more-info {
            margin: 20px 0 0;
        }
    </style>
    <div style="width: 100%">
        <div class="bar"></div>
        <div id="timeline"  class="timeline">
            <timeline-now id="now"></timeline-now>
            <content select="timeline-item"></content>
        </div>
    </div>
    <core-collapse id="collapsebox" on-core-resize="{{ collapseResize }}">
        <div id="infobox"></div>
        <div id="more-info">
            <paper-button on-click="{{ openHighlighted }}" style="background-color: #eeeeee" raised>More info...
            </paper-button>
        </div>
    </core-collapse>
</template>
<script>
    Polymer({
        openingItem: null,
        highlightedItem: null,
        timeSpanStart: new Date(new Date().getTime() - 1000 * 60 * 60 * 24 * 7 * 2).getTime() / 1000,
        timeSpanEnd: new Date(new Date().getTime() + 1000 * 60 * 60 * 24 * 7 * 4).getTime() / 1000,
        trackX: 0,
        tracking: false,
        trackDelta: 0,
        trackInterval: null,
        scaling: false,
        pinchLength: 0,
        ready: function () {
            var items = this.querySelectorAll('timeline-item');
            var me = this;
            for (var i = 0; i < items.length; i++) {
                var item = items[i];
                item.addEventListener('item-highlighted', function (event) {
                    me.highlighted(event);
                });
                item.addEventListener('item-unhighlighted', function (event) {
                    me.unhighlighted(event);
                });
                item.addEventListener('item-open', function (event) {
                    me.open(event.target);
                });
            }

            this.update();
        },
        update: function () {
            this.$.now.lineWidth = this.clientWidth;
            this.$.now.timeSpanStart = this.timeSpanStart;
            this.$.now.timeSpanEnd = this.timeSpanEnd;

            var items = this.querySelectorAll('timeline-item');
            for (var i = 0; i < items.length; i++) {
                var item = items[i];
                item.lineWidth = this.clientWidth;
                item.timeSpanStart = this.timeSpanStart;
                item.timeSpanEnd = this.timeSpanEnd;
            }
        },
        calculatePinchLength: function (e) {
            return this.pinchLength =
                    Math.sqrt((e.touches[0].pageX - e.touches[1].pageX) * (e.touches[0].pageX - e.touches[1].pageX) +
                            (e.touches[0].pageY - e.touches[1].pageY) * (e.touches[0].pageY - e.touches[1].pageY));
        },
        touchstart: function (e) {
            if (e.touches.length == 2) {
                this.scaling = true;
                this.calculatePinchLength(e);
            }
        },
        touchend: function (e) {
            this.scaling = this.scaling && e.touches.length >= 2;
        },
        touchmove: function (e) {
            if (this.scaling) {
                if(e.touches.length < 2) {
                    return;
                }

                var previous = this.pinchLength;
                var now = this.calculatePinchLength(e);

                var rate = (this.timeSpanEnd - this.timeSpanStart) / this.clientWidth;
                var diff = now - previous;
                var minX= Math.min(e.touches[0].pageX, e.touches[1].pageX);
                var maxX= Math.max(e.touches[0].pageX, e.touches[1].pageX);
                var focusPx = minX + (maxX - minX) / 2;

                var focusRate = focusPx / this.clientWidth;

                //console.log(focusPx);
                this.timeSpanStart += diff * rate * (focusRate);
                this.timeSpanEnd -= diff * rate * (1-focusRate);

            }
        },
        trackstart: function (event) {
            this.trackX = event.clientX;
            this.tracking = !this.scaling;
        },
        trackend: function () {
            if(!this.tracking){
                return;
            }
            this.tracking = false;
        },
        track: function (event) {
            if(this.scaling) {
                this.tracking = false;
            }
            if(this.tracking) {
                this.trackDelta = event.clientX - this.trackX;
                this.trackX = event.clientX;

                if (Math.abs(this.trackDelta) > 0) {
                    var rate = (this.timeSpanEnd - this.timeSpanStart) / this.clientWidth;
                    this.timeSpanStart -= this.trackDelta * rate;
                    this.timeSpanEnd -= this.trackDelta * rate;
                }
            }
        },
        timeSpanStartChanged: function () {
            this.$.now.timeSpanStart = this.timeSpanStart;
            var items = this.querySelectorAll('timeline-item');
            for (var i = 0; i < items.length; i++) {
                items[i].timeSpanStart = this.timeSpanStart;
            }
        },
        timeSpanEndChanged: function () {
            this.$.now.timeSpanEnd = this.timeSpanEnd;
            var items = this.querySelectorAll('timeline-item');
            for (var i = 0; i < items.length; i++) {
                items[i].timeSpanEnd = this.timeSpanEnd;
            }
        },
        showItem: function (item) {
            while (this.$.infobox.hasChildNodes()) {
                this.$.infobox.removeChild(this.$.infobox.lastChild);
            }

            for (var i = 0; i < item.children.length; i++) {
                this.$.infobox.appendChild(item.children[i].cloneNode(true));
            }
        },
        collapseResize: function (event) {
            if (!event.target.opened && this.openingItem) {
                this.showItem(this.openingItem);
                event.target.opened = true;
                this.openingItem = null;
            }
        },
        open: function (item) {
            console.log('open', item);
        },
        openHighlighted: function () {
            if (this.highlightedItem) {
                this.open(this.highlightedItem);
            }
        },
        highlighted: function (event) {
            var delayed = this.$.collapsebox.opened;
            Array.prototype.forEach.call(this.querySelectorAll('timeline-item'), function (item) {
                item.unhighlight();
            });

            this.highlightedItem = event.target;

            if (delayed) {
                this.openingItem = event.target;
                return;
            }

            this.showItem(event.target);
            this.$.collapsebox.opened = true;
        },
        unhighlighted: function (event) {
            this.highlightedItem = null;
            this.$.collapsebox.opened = false;
        }
    });
</script>
</polymer-element>